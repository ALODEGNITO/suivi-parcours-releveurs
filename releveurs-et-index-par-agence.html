<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Les releveurs & index relevÃ©s par agence</title>
<script>
        fetch("/favicon.html")
        .then(res => res.text())
        .then(html => {
            document.head.innerHTML += html;
        });
</script>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- FONT AWESOME -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<!-- PDF & EXCEL -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
:root {
    --primary:#2563eb;
    --secondary:#1e40af;
    --bg:#f5f7fa;
    --card:#ffffff;
    --danger:#dc2626;
    --success:#16a34a;
    --warning:#f59e0b;
}

body {
    font-family: "Segoe UI", sans-serif;
    background: var(--bg);
    padding: 20px;
}

/* TITRE */
h2 {
    text-align: center;
    color: var(--primary);
    margin-bottom: 20px;
}

/* BOUTONS */
.btn {
    padding: 10px 14px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    color: #fff;
    font-weight: 600;
}
.btn-danger { background: var(--danger); }
.btn-primary { background: var(--primary); }
.btn-success { background: var(--success); }

.top-actions {
    display: flex;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 15px;
}

/* FILTRES */
.filters {
    display: grid;
    grid-template-columns: repeat(auto-fit,minmax(200px,1fr));
    gap: 12px;
    margin-bottom: 15px;
}

select {
    padding: 10px;
    border-radius: 8px;
}

/* TOTAL */
.total-box {
    background: var(--card);
    padding: 15px;
    border-left: 6px solid var(--primary);
    font-size: 18px;
    font-weight: bold;
    border-radius: 10px;
    margin-bottom: 15px;
}

/* TABLE */
.table-wrapper {
    background: var(--card);
    border-radius: 12px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.08);
    overflow: hidden;
}

table {
    width: 100%;
    border-collapse: collapse;
}

thead {
    background: linear-gradient(90deg,var(--primary),var(--secondary));
    color: #fff;
}

th, td {
    padding: 12px;
    text-align: center;
}

tbody tr:hover {
    background: #eff6ff;
}

/* BARRE DE PROGRESSION */
.progress {
    background: #e5e7eb;
    border-radius: 8px;
    height: 14px;
    overflow: hidden;
}

.progress-bar {
    height: 100%;
    transition: width 0.4s;
}

.green { background: var(--success); }
.orange { background: var(--warning); }
.red { background: var(--danger); }

/* PAGINATION */
.pagination {
    display: flex;
    justify-content: space-between;
    margin-top: 15px;
}

/* LOADER */
.loader {
    position: fixed;
    inset: 0;
    background: rgba(255,255,255,0.85);
    display: none;
    align-items: center;
    justify-content: center;
    font-size: 40px;
    color: var(--primary);
    z-index: 999;
}
</style>
</head>
<!-- code pour controler les inactivites -->
<!-- <script src="js/logout.js"></script>-->

<body>

<div class="loader" id="loader">
    <i class="fas fa-spinner fa-spin"></i>
</div>

<h2><i class="fas fa-chart-line"></i> Les releveurs & index relevÃ©s par agence</h2>

<div class="top-actions">
    <button class="btn btn-danger" onclick="history.back()">
        <i class="fas fa-arrow-left"></i> Retour
    </button>

    <div>
        <button class="btn btn-primary" onclick="exportPDF()">
            <i class="fas fa-file-pdf"></i> PDF
        </button>
        <button class="btn btn-success" onclick="exportExcel()">
            <i class="fas fa-file-excel"></i> Excel
        </button>
    </div>
</div>

<div class="filters">
    <select id="departement">
        <option value="">DÃ©partement</option>
        <option value="7">DÃ©partement 7</option>
    </select>

    <select id="agence">
        <option value="">Agence</option>
        <option value="2">Agence 2</option>
    </select>

    <select id="pageSize">
        <option value="10">10 lignes</option>
        <option value="20">20 lignes</option>
        <option value="50">50 lignes</option>
    </select>
</div>

<div class="total-box">
    Total relevÃ©s : <span id="total">0 / 0</span>
</div>

<div class="table-wrapper">
<table id="dataTable">
    <thead>
        <tr>
            <th>Matricule</th>
            <th>Nom du Releveur</th>
            <th>Nombre total Ã  relever</th>
            <th>Nombre total relevÃ©s</th>
            <th>Nombre total restant</th>
            <th>Progression</th>
        </tr>
    </thead>
    <tbody id="tableBody"></tbody>
</table>
</div>

<div class="pagination">
    <span id="pageInfo"></span>
    <div>
        <button class="btn btn-primary" onclick="prevPage()">â—€</button>
        <button class="btn btn-primary" onclick="nextPage()">â–¶</button>
    </div>
</div>

<script>

const API_DETAILS = "http://41.138.61.43:8081/api/wseentrelec/1326"; // dÃ©tail points
const API_RELEVEURS = "http://41.138.61.43:8081/api/wseentrelec";   // infos releveurs

let allData = [];
let releveursData = [];
let filtered = [];
let page = 1;
let pageSize = 10;

const body = document.getElementById("tableBody");
const totalSpan = document.getElementById("total");
const loader = document.getElementById("loader");
const departement = document.getElementById("departement");
const agence = document.getElementById("agence");
const pageInfo = document.getElementById("pageInfo");
const pageSizeSelect = document.getElementById("pageSize");


// ðŸ”¹ Charger les deux APIs
async function loadData() {

    loader.style.display = "flex";

    try {

        const [res1, res2] = await Promise.all([
            fetch(API_DETAILS),
            fetch(API_RELEVEURS)
        ]);

        allData = await res1.json();
        releveursData = await res2.json();

    } catch (err) {
        console.error("Erreur chargement :", err);
    }

    loader.style.display = "none";
}


// ðŸ”¹ Appliquer filtres
function applyFilters() {

    const d = departement.value;
    const a = agence.value;

    if (!d || !a) {
        body.innerHTML = "";
        totalSpan.textContent = "0 / 0";
        return;
    }

    const dataFiltered = allData.filter(x =>
        x.deptrl == d && x.agenrl == a
    );

    const grouped = {};

    dataFiltered.forEach(row => {

        const matricule = row.codrrl;

        if (!grouped[matricule]) {
            grouped[matricule] = {
                total: 0,
                releves: 0,
                restant: 0
            };
        }

        grouped[matricule].total++;

        if (row.daterp != 0) {
            grouped[matricule].releves++;
        } else {
            grouped[matricule].restant++;
        }

    });

    // ðŸ”¥ Fusion avec API_RELEVEURS pour rÃ©cupÃ©rer le nom
    filtered = Object.keys(grouped).map(key => {

        const releveurInfo = releveursData.find(r => r.matriaa == key);

        return {
            matricule: key,
            nom: releveurInfo ? releveurInfo.nomaa : "Nom inconnu",
            total: grouped[key].total,
            releves: grouped[key].releves,
            restant: grouped[key].restant
        };

    });

    page = 1;
    render();
}


// ðŸ”¹ Affichage
function render() {

    body.innerHTML = "";

    let start = (page - 1) * pageSize;
    let rows = filtered.slice(start, start + pageSize);

    let totalReleves = 0;
    let totalPoints = 0;

    rows.forEach(r => {

        const pct = r.total
            ? Math.round((r.releves / r.total) * 100)
            : 0;

        let color =
            pct >= 80 ? "green" :
            pct >= 50 ? "orange" :
            "red";

        totalReleves += r.releves;
        totalPoints += r.total;

        body.innerHTML += `
        <tr>
            <td>${r.matricule}</td>
            <td>${r.nom}</td>
            <td>${r.total}</td>
            <td>${r.releves}</td>
            <td>${r.restant}</td>
            <td>
                ${pct}%
                <div class="progress">
                    <div class="progress-bar ${color}" style="width:${pct}%"></div>
                </div>
            </td>
        </tr>
        `;
    });

    totalSpan.textContent = `${totalReleves} / ${totalPoints}`;
    pageInfo.textContent = `Page ${page}`;
}


// ðŸ”¹ Pagination
function prevPage() {
    if (page > 1) {
        page--;
        render();
    }
}

function nextPage() {
    if (page * pageSize < filtered.length) {
        page++;
        render();
    }
}


// ðŸ”¹ Events
pageSizeSelect.addEventListener("change", e => {
    pageSize = +e.target.value;
    render();
});

departement.addEventListener("change", applyFilters);
agence.addEventListener("change", applyFilters);


// ðŸ”¹ Export PDF
function exportPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.autoTable({ html: '#dataTable' });
    doc.save("statistiques.pdf");
}


// ðŸ”¹ Export Excel
function exportExcel() {
    const wb = XLSX.utils.table_to_book(document.querySelector("#dataTable"));
    XLSX.writeFile(wb, "statistiques.xlsx");
}


// ðŸ”¹ Init
loadData();

</script>


</body>
</html>
