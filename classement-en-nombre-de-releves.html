<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />

<!-- code responsive -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>Parcours Releveur</title>

<!-- Style global -->
<link rel="stylesheet" href="css/style.css">

        <script>
            fetch("/favicon.html")
            .then(res => res.text())
            .then(html => {
                document.head.innerHTML += html;
            });
        </script>
<title>Classement des Releveurs par nombre de points relev√©s</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
body { margin:0; font-family: Arial, sans-serif; background:#f5f6fa; padding:20px; }
h2 { text-align:center; color:#2563eb; }
table { width:100%; border-collapse:collapse; margin-top:20px; background:#fff; box-shadow:0 2px 5px rgba(0,0,0,.1); }
th, td { border:1px solid #ddd; padding:10px; text-align:center; font-size:14px; }
th { background:#007bff; color:#fff; cursor:pointer; }
tr:nth-child(even) { background:#f9f9f9; }
button { padding:8px 12px; margin:5px; background:#007bff; color:#fff; border:none; border-radius:4px; cursor:pointer; }
button:hover { background:#0056b3; }
.badge { padding:4px 8px; border-radius:4px; color:#fff; font-size:12px; }
.en-avance { background:green; }
.bon-rythme { background:green; }
.en-cours { background:orange; }
.en-retard { background:red; }
.presque-terminee{ background:rgb(0, 136, 255); }
.terminee { background:blue; }
#top3 { margin-top:20px; padding:10px; background:#fff; box-shadow:0 2px 5px rgba(0,0,0,.1); }
.alert { background:#ffdddd; padding:8px; margin:5px 0; border-left:5px solid red; }
.rank-btn { background: #ff0707; color:#fff; } .rank-btn:hover { background: #e0a800; }

/* üì± Adaptation du petit graphe */
/* #rankingChart {
    max-width: 100%;
    min-height: 300px;  /* ‚úÖ Hauteur augment√©e *
}*/

/* üì± Adaptation d'agrandissement du graphe */
#rankingChart {
    max-width: 100%;
    min-height: 500px; /* ‚úÖ Hauteur augment√©e */
    width: 100%;
}


canvas {
    display:block;
    margin:0 auto;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}


/* Representation des couleurs du graphes */
#chartLegend h4 {
    margin-bottom: 8px;
    color: #333;
}

#chartLegend ul li {
    display: flex;
    align-items: center;
}


/* ===== 29.01.2026 ===== */
/* ===== HEADER FIXE ===== */
.fixed-header {
    position: sticky;
    top: 0;
    z-index: 999;
    background: #f5f6fa;
    padding: 15px 0;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
}

/* Espace entre header et tableau */
.fixed-header h2 {
    margin: 10px 0;
    font-size: 20px;
}

/* Boutons bien align√©s */
.btn-group {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 8px;
    margin-top: 10px;
}

/* ===== TABLEAU AVEC SCROLL ===== */
.table-wrapper {
    max-height: 420px; /* tu peux augmenter si tu veux */
    overflow-y: auto;
    margin-top: 20px;
    border-radius: 6px;
}

/* ===== ENT√äTE TABLEAU FIXE ===== */
thead th {
    position: sticky;
    top: 0;
    z-index: 10;
    background: #007bff;
    color: #fff;
}


/* ========= IMPRESSION ULTRA PRO ========= */

.print-header,
.print-footer{ display:none; }

@media print{

    @page{
        size:A4 landscape;
        margin:12mm;
    }

    body{ background:white; padding:0; }

    /* cacher interface */
    .fixed-header,
    #toggleBtn,
    #top3,
    #rankingChart,
    #chartLegend,
    #alerts,
    #loader{
        display:none !important;
    }

    #printArea{ display:block; }

    /* HEADER */
    .print-header{
        display:flex;
        align-items:center;
        justify-content:space-between;
        margin-bottom:10px;
    }

    .print-logo{ height:55px; }

    .print-title-box{
        flex:1;
        text-align:center;
        font-weight:bold;
    }

    .print-main-title{ font-size:20px; }
    .print-sub{ font-size:12px; margin-top:3px; }

    /* FOOTER */
    .print-footer{
        display:block;
        position:fixed;
        bottom:5mm;
        left:0;
        right:0;
        font-size:11px;
        color:#444;
    }

    .footer-left{ float:left; }
    .footer-right{ float:right; }

    .page-number:after{
        content:"Page " counter(page) " / " counter(pages);
    }

    /* TABLE */
    .table-wrapper{
        max-height:none !important;
        overflow:visible !important;
        border:none;
    }

    table{
        width:100%;
        font-size:10.5px;
        border-collapse:collapse;
    }

    th{
        background:#eee !important;
        color:black !important;
    }

    th,td{
        border:1px solid #888;
        padding:4px;
    }

    tr{ page-break-inside:avoid; }
    thead{ display:table-header-group; }
}



/* ===== LOADER PRO MODERNE ===== */

#loaderPro{
    position:fixed;
    /*top:20px;*/
    top:330px;
    left:50%;
    transform:translateX(-50%);
    z-index:9999;
    transition:opacity .3s ease, transform .3s ease;
    pointer-events:none; /* IMPORTANT: page reste cliquable */
}

.loader-hidden{
    opacity:0;
    transform:translate(-50%,-15px);
}

.loader-visible{
    opacity:1;
    transform:translate(-50%,0);
}

.loader-box{
    background:white;
    padding:14px 18px;
    border-radius:14px;
    box-shadow:0 6px 25px rgba(0,0,0,0.15);
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:8px;
    min-width:220px;
    font-family:Arial,sans-serif;
}

/* spinner moderne */
.spinner-pro{
    width:28px;
    height:28px;
    border:3px solid #e6e6e6;
    border-top:3px solid #007bff;
    border-radius:50%;
    animation:spinPro .8s linear infinite;
}

@keyframes spinPro{
    to{ transform:rotate(360deg); }
}

/* texte */
.loader-text{
    font-size:14px;
    color:#333;
}

/* barre */
.progress-bar{
    width:100%;
    height:4px;
    background:#eee;
    border-radius:4px;
    overflow:hidden;
}

.progress{
    width:40%;
    height:100%;
    background:#007bff;
    animation:progressMove 1.2s infinite ease-in-out;
}

@keyframes progressMove{
    0%{ transform:translateX(-100%); }
    50%{ transform:translateX(120%); }
    100%{ transform:translateX(250%); }
}


</style>
</head>

<!-- code pour controler les inactivites -->
<!-- <script src="js/logout.js"></script>-->

<body>

<!-- ===== LOADER PRO ===== -->
<div id="loaderPro" class="loader-hidden">
    <div class="loader-box">
        <div class="spinner-pro"></div>
        <div class="loader-text">Chargement des donn√©es...</div>
        <div class="progress-bar">
            <div class="progress"></div>
        </div>
    </div>
</div>    


<div class="fixed-header">    
    <button onclick="window.location.href='admin-map.html'" style="background-color:#b91c1c;">
    ‚¨Ö Retour √† la carte</button>
    <h2>üèÜ Classement G√©n√©ral des Releveurs par Nombre de Points Visit√©s et Relev√©s</h2>

    <div>
        <!-- <button onclick="sortRanking('percent')">Trier par %</button>-->
        <button onclick="sortRanking('effectue')">Trier par effectu√©s</button>
        <button onclick="sortRanking('restant')">Trier par restants</button>
        <button onclick="sortRanking('temps')">Trier par temps</button>
        <button onclick="exportExcel()" style="background:#16a34a;">üìä Export Excel</button>
        <!-- <button onclick="exportPDF()">üìÑ Export PDF</button>-->
        <button onclick="printClassementPro()" style="background:#16a34a;">
            üñ® Impression PDF
        </button>

        <button onclick="window.location.href='classement_individuel.html'">
        Statistiques Personnelles d'un Releveur</button>
        <button onclick="window.location.href='classement.html'">
        Classement par %</button>
        <button class="rank-btn" onclick="window.location.href='accueil.html'" style="background-color:#b91c1c;">
        Retour</button>
    </div>
</div>

<div id="printArea">

<div class="print-header">
    <img src="images/logos-NDE.png" class="print-logo">

    <div class="print-title-box">
        <div class="print-main-title">
            CLASSEMENT G√âN√âRAL DES RELEVEURS PAR NOMBRE DE POINTS RELEV√âS
        </div>

        <div class="print-sub" id="printDate"></div>
        <div class="print-sub" id="printTotals"></div>
    </div>
</div>

<div class="table-wrapper">
    <table>
        <thead>
            <tr>
                <th>Matricule</th>
                <th>Nom du releveur</th>
                <th>Nombre de Points √† relever</th>
                <th>Points effectu√©s</th>
                <th>Points restants</th>
                <th>Points relev√©s suivi</th>
                <th>Statut</th>
            </tr>
        </thead>
        <tbody id="rankingTable"></tbody>
    </table>
</div>
</div>  <!-- fin printArea -->


<!-- üîò Bouton afficher tout / moins -->
<div style="text-align:center; margin-top:10px;">
    <button id="toggleBtn" onclick="toggleTable()">‚¨áÔ∏è Afficher tout</button>
</div>


<div id="top3">
    <h3>ü•á Top 3 Releveurs</h3>
    <ol id="topList"></ol>
</div>

<!-- ‚úÖ Graphique responsive avec hauteur augment√©e -->
<div style="max-width:100%; margin:auto;">
    <canvas id="rankingChart"></canvas>
</div>

<!-- L√©gende du graphique -->
<div id="chartLegend" style="margin-top:15px; text-align:center;">
    <h4>üóÇÔ∏è L√©gende des couleurs</h4>
    <ul style="list-style:none; padding:0; display:flex; justify-content:center; gap:20px; font-size:14px;">
        <li><span class="color-box" style="background:blue; width:15px; height:15px; display:inline-block; margin-right:6px; border-radius:3px;"></span>Bleu : Tourn√©e Termin√©e</li>
        <li><span class="color-box" style="background:#007bff; width:15px; height:15px; display:inline-block; margin-right:6px; border-radius:3px;"></span>Bleu ciel : ‚â• 2000 points</li>
        <li><span class="color-box" style="background:green; width:15px; height:15px; display:inline-block; margin-right:6px; border-radius:3px;"></span>Vert : entre 1000 et 2000 points</li>
        <li><span class="color-box" style="background:orange; width:15px; height:15px; display:inline-block; margin-right:6px; border-radius:3px;"></span>Orange : < 1000 points</li>
    </ul>
</div>


<div id="alerts"></div>

<script>
/*let rankingData = [
    { matricule:"0001", nom:"Garba Amadou", total:120, effectue:120, start:new Date(Date.now()-3600*1000) },
    { matricule:"0002", nom:"Aminata Kon√©", total:110, effectue:92, start:new Date(Date.now()-5400*1000) },
    { matricule:"0003", nom:"Ami Alhadj", total:98, effectue:80, start:new Date(Date.now()-7200*1000) },
    { matricule:"0004", nom:"Fatou Diallo", total:85, effectue:70, start:new Date(Date.now()-3000*1000) },
    { matricule:"0005", nom:"Souley Soumaila", total:70, effectue:50, start:new Date(Date.now()-2000*1000) }
];*/

let rankingData = [];

//Fonction api des releves effectu√©s par les releveurs
async function fetchRankingData() {
    showLoader("Chargement donn√©es...");
    try {
        const response = await fetch("http://41.138.61.43:8081/api/wseentrelec");
        if (!response.ok) throw new Error("Erreur r√©seau: " + response.status);
        const data = await response.json();

        rankingData = data.map(item => ({
            matricule: item.matriaa,
            nom: item.nomaa,
            total: Number(item.nbretotal),
            effectue: Number(item.nbrerele),
            start: new Date()
        }));

        renderRanking();
    } catch (err) {
        console.error("Erreur lors du chargement des donn√©es:", err);
        alert("‚ùå Impossible de charger les donn√©es depuis le serveur !");
    } finally {
        hideLoader();
    }

    return rankingData; // ‚úÖ n√©cessaire pour que then() fonctionne
}



let showAll = false; // √âtat d‚Äôaffichage du tableau

function renderRanking() {
    const tbody = document.getElementById("rankingTable");
    tbody.innerHTML = "";

    const moyenne = rankingData.reduce((a, r) => a + (r.effectue / r.total), 0) / rankingData.length;

    // ‚úÖ Affiche soit tout, soit seulement les 5 premiers
    const dataToShow = showAll ? rankingData : rankingData.slice(0, 5);

    dataToShow.forEach(r => {
        const restant = r.total - r.effectue;
        //const percent = (r.effectue / r.total);
        //const stat = r.effectue + " points";
        const percent = (r.effectue / r.total) * 100;
        //const stat = r.effectue + " pts (" + percent.toFixed(1) + "%)";
        const stat = r.effectue + " pts";
    
        let badge = "", cls = "";
        if (r.effectue >= r.total) {
        badge = "‚úÖ Tourn√©e termin√©e";
        cls = "terminee";
        } else if (r.effectue >= 2000) {
            badge = "üéØ Presque Terminee ";
            cls = "presque-terminee ";
        } else if (r.effectue >= 1000) {
            badge = "‚è≥ En avance";
            cls = "en-avance";
        } else if (r.effectue > 0) {
            badge = "‚ö†Ô∏è En cours";
            cls = "en-cours";
        } else {
            badge = "‚ùå Non commenc√©";
            cls = "en-retard";
        }


        tbody.innerHTML += `
            <tr>
                <td>${r.matricule}</td>
                <td>${r.nom}</td>
                <td>${r.total}</td>
                <td>${r.effectue}</td>
                <td>${restant}</td>
                <td>${stat}</td>
                <td><span class="badge ${cls}">${badge}</span></td>
            </tr>
        `;
    });

    updateTop3();
    updateChart();
    checkAlerts();

    // ‚úÖ Met √† jour le texte du bouton
    const btn = document.getElementById("toggleBtn");
    if (btn) btn.textContent = showAll ? "‚¨ÜÔ∏è Afficher moins" : "‚¨áÔ∏è Afficher tout";
}


function updateTop3(){
    // üî• Tri du top 3 par nombre de points effectu√©s (nbrerele)
    const top = [...rankingData].sort((a, b) => b.effectue - a.effectue).slice(0, 3);
    const list = document.getElementById("topList");
    list.innerHTML = "";
    top.forEach(r => {
        list.innerHTML += `<li>${r.nom} - ${r.effectue} points relev√©s</li>`;
    });
}


let chart;
function updateChart(){
    const ctx = document.getElementById("rankingChart").getContext("2d");
    if(chart) chart.destroy();

    chart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: rankingData.map(r => r.nom),
            datasets: [{
                data: rankingData.map(r => r.effectue),
                label: "Nombre de points relev√©s",
                backgroundColor: rankingData.map(r => {
                    if (r.effectue >= 2000) return "#007bff";   // üîµ Excellent
                    else if (r.effectue >= 1000) return "green"; // üü¢ Moyen
                    else return "orange";                     // üü† Faible
                })
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { 
                legend: { display: true } 
            },
            scales: { 
                y: { 
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: "Points relev√©s"
                    }
                } 
            }
        }
    });
}


/*function sortRanking(crit){
    if(crit=="percent") rankingData.sort((a,b)=>(b.effectue/b.total)-(a.effectue/a.total));
    if(crit=="effectue") rankingData.sort((a,b)=>b.effectue-a.effectue);
    if(crit=="restant") rankingData.sort((a,b)=>(a.total-a.effectue)-(b.total-b.effectue));
    if(crit=="temps") rankingData.sort((a,b)=>a.start-b.start);
    renderRanking();
}*/

/*function sortRanking(crit){
    showLoader(); // ‚úÖ Affiche le loader

    setTimeout(() => { // Simule un court d√©lai de tri
        if(crit=="percent") rankingData.sort((a,b)=>(b.effectue/b.total)-(a.effectue/a.total));
        if(crit=="effectue") rankingData.sort((a,b)=>b.effectue-a.effectue);
        if(crit=="restant") rankingData.sort((a,b)=>(a.total-a.effectue)-(b.total-b.effectue));
        if(crit=="temps") rankingData.sort((a,b)=>a.start-b.start);
        
        renderRanking();
        hideLoader(); // ‚úÖ Cache le loader une fois le tri termin√©
    }, 700); // 0,7 seconde d‚Äôanimation
}*/


function sortRanking(crit){
    showLoader("Chargement donn√©es...");
    setTimeout(() => {
        //if(crit=="percent") rankingData.sort((a,b)=>b.effectue-a.effectue); // devient tri par nbrerele
        if(crit=="effectue") rankingData.sort((a,b)=>b.effectue-a.effectue);
        if(crit=="restant") rankingData.sort((a,b)=> (a.total - a.effectue) - (b.total - b.effectue));
        if(crit=="temps") rankingData.sort((a,b)=>a.start-b.start);
        renderRanking();
        hideLoader();// ‚úÖ Cache le loader une fois le tri termin√©
    }, 700); // 0,7 seconde d‚Äôanimation
}



function exportExcel(){
    const ws=XLSX.utils.json_to_sheet(rankingData.map(r=>({
        Matricule:r.matricule,
        Nom:r.nom,
        Total:r.total,
        Effectue:r.effectue,
        Restant:r.total-r.effectue,
        //Pourcentage:(r.effectue/r.total*100).toFixed(1)+"%"
        Points_Relev√©s: r.effectue
    })));
    const wb=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,ws,"Classement");
    XLSX.writeFile(wb,"classement.xlsx");
}

/*function exportPDF(){
    const { jsPDF } = window.jspdf;
    const doc=new jsPDF();
    doc.text("Classement des Releveurs",20,20);
    let y=40;
    rankingData.forEach(r=>{
        //doc.text(`${r.matricule} - ${r.nom} - ${(r.effectue/r.total*100).toFixed(1)}%`,20,y);
        doc.text(`${r.matricule} - ${r.nom} - ${r.effectue} points`,20,y);
        y+=10;
    });
    doc.save("classement.pdf");
}*/

// --- Gestion des alertes avec affichage limit√© ---
let showAllAlerts = false; // √âtat d'affichage des alertes (false = seulement 5)

function checkAlerts() {
    const div = document.getElementById("alerts");
    div.innerHTML = "";

    // Filtrer les releveurs en retard
    const alerts = rankingData
        .filter(r => {
            const restant = r.total - r.effectue;
            return restant > 20 && (r.effectue / r.total) < 0.3;
        })
        .map(r => ({
            nom: r.nom,
            restant: r.total - r.effectue
        }));

    if (alerts.length === 0) {
        div.innerHTML = "<p style='color:green; text-align:center;'>‚úÖ Aucun retard signal√© !</p>";
        return;
    }

    // ‚úÖ Affiche seulement les 5 premi√®res si showAllAlerts = false
    const alertsToShow = showAllAlerts ? alerts : alerts.slice(0, 5);

    alertsToShow.forEach(a => {
        div.innerHTML += `
            <div class="alert">‚ö†Ô∏è ${a.nom} a encore ${a.restant} points et est en retard !</div>
        `;
    });

    // ‚úÖ Bouton "Afficher tout / R√©duire"
    if (alerts.length > 5) {
        const btnText = showAllAlerts ? "‚¨ÜÔ∏è R√©duire les alertes" : "‚¨áÔ∏è Afficher toutes les alertes";
        div.innerHTML += `
            <div style="text-align:center; margin-top:8px;">
                <button onclick="toggleAlerts()">${btnText}</button>
            </div>
        `;
    }
}

function toggleAlerts() {
    showAllAlerts = !showAllAlerts;
    checkAlerts(); // recharge la section avec le bon √©tat
}


// Simulation mise √† jour automatique
/*setInterval(()=>{
    rankingData.forEach(r=>{
        if(r.effectue<r.total) r.effectue+=Math.random()<0.3?1:0;
    });
    renderRanking();
},5000);*/


setInterval(fetchRankingData, 420000); // recharge les donn√©es toutes les 7 minutes

//renderRanking();

//fetchRankingData();

fetchRankingData().then(() => {
    sortRanking('effectue'); // Trie automatiquement √† l'entr√©e
});


//Les fonctions indicateur de chargement 

function showLoader(text="Chargement des donn√©es..."){
    const l=document.getElementById("loaderPro");
    l.querySelector(".loader-text").textContent=text;
    l.classList.remove("loader-hidden");
    l.classList.add("loader-visible");
}

function hideLoader(){
    const l=document.getElementById("loaderPro");
    l.classList.remove("loader-visible");
    l.classList.add("loader-hidden");
}



function toggleTable() {
    showAll = !showAll; // inverse l‚Äô√©tat (afficher tout / partiel)
    renderRanking();    // recharge le tableau selon le nouvel √©tat
}


//Fonction d'impression
function printClassementPro(){

    const d = new Date();

    document.getElementById("printDate").innerHTML =
        "Imprim√© le : "
        + d.toLocaleDateString()
        + " √† "
        + d.toLocaleTimeString();

    const totalReleveurs = rankingData.length;
    const totalPoints = rankingData.reduce((a,r)=>a+r.total,0);
    const totalEffectue = rankingData.reduce((a,r)=>a+r.effectue,0);

    document.getElementById("printTotals").innerHTML =
        "Releveurs : "+totalReleveurs+
        " | Points √† relever : "+totalPoints+
        " | Points relev√©s : "+totalEffectue;

    window.print();
}

</script>

<div class="print-footer">
    <div class="footer-left">
        Soci√©t√© Nationale des Eaux
    </div>
    <div class="footer-right page-number"></div>
</div>

</body>
</html>
